<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>ì°½ì› ì„±ë¯¼ì—¬ìê³ ë“±í•™êµ í¬í„¸ (í†µí•©)</title>
<style>
  :root{--bg:#f4f7fb;--card:#fff;--accent:#2c7be5;--muted:#7b8a99}
  body{font-family: Inter, Noto Sans KR, Arial, sans-serif; background:var(--bg); margin:0; padding:20px; color:#263238}
  .wrap{max-width:1100px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  h1{margin:0;font-size:20px;color:#16325c}
  section.card{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 6px 18px rgba(20,40,60,0.06);margin-bottom:16px}
  .flex{display:flex;gap:12px;align-items:center}
  input[type="text"], input[type="password"], input[type="number"], textarea, select {
    padding:8px;border-radius:6px;border:1px solid #d9e2ec;background:#fff;width:100%;box-sizing:border-box;
  }
  button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
  button.ghost{background:#fff;color:var(--accent);border:1px solid #d9e2ec}
  .small{padding:6px 8px;font-size:13px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eef3f8;text-align:left}
  th{background:#fbfdff;color:#16325c}
  .calendar{display:flex;flex-wrap:wrap;width:320px}
  .day{width:40px;height:40px;margin:3px;border-radius:6px;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid #e6eef8;cursor:pointer}
  .day.event{background:#f39c12;color:white;border:none}
  .right{float:right}
  .center{text-align:center}
  .muted{color:var(--muted);font-size:13px}
  .table-scroll{max-height:360px;overflow:auto}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .search-row{display:flex;gap:8px;align-items:center}
  .file-preview{margin-top:8px;font-size:13px;color:var(--muted)}
  .pagination{display:flex;gap:6px;justify-content:center;margin-top:12px}
  .post-row{display:flex;gap:8px;align-items:center}
  .badge{background:#eef6ff;color:#1765d8;padding:3px 8px;border-radius:999px;font-size:12px}
  .center-area{text-align:center;margin-top:12px}
  .comment{border-left:3px solid #eef3f8;padding:8px;margin:8px 0;background:#fff}
  .file-link{display:inline-block;margin-top:6px;color:#1765d8;text-decoration:underline;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">

<header>
  <h1>ì°½ì› ì„±ë¯¼ì—¬ìê³ ë“±í•™êµ í¬í„¸ â€” í†µí•©íŒ</h1>
  <div id="top-user" class="muted">ë¡œê·¸ì¸ í•„ìš”</div>
</header>

<!-- ë¡œê·¸ì¸ / íšŒì›ê°€ì… -->
<section id="auth-card" class="card">
  <div id="login-panel">
    <h2 style="margin:0 0 8px 0">ë¡œê·¸ì¸</h2>
    <div class="flex" style="gap:8px">
      <input id="login-id" placeholder="ì•„ì´ë”” (ì˜ˆ: test)" style="max-width:220px">
      <input id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" type="password" style="max-width:220px">
      <button id="login-btn" class="small">ë¡œê·¸ì¸</button>
      <button id="show-signup-btn" class="small ghost">íšŒì›ê°€ì…</button>
    </div>
    <p class="muted" style="margin-top:8px">í…ŒìŠ¤íŠ¸ ê³„ì •: <strong>id=test pw=1234 (2í•™ë…„ 7ë°˜)</strong></p>
  </div>

  <div id="signup-panel" style="display:none">
    <h2 style="margin:0 0 8px 0">íšŒì›ê°€ì…</h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <input id="signup-id" placeholder="ì•„ì´ë””">
      <input id="signup-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" type="password">
      <input id="signup-grade" placeholder="í•™ë…„ (1~3)" type="number" min="1" max="3">
      <input id="signup-class" placeholder="ë°˜ (1~8)" type="number" min="1" max="8">
    </div>
    <div style="margin-top:8px" class="flex">
      <button id="signup-btn" class="small">ê°€ì…í•˜ê¸°</button>
      <button id="hide-signup-btn" class="small ghost">ì·¨ì†Œ</button>
    </div>
  </div>
</section>

<!-- í¬í„¸ (hidden until login) -->
<section id="portal" style="display:none">
  <div class="card">
    <div class="topbar">
      <div>
        <strong id="user-info">â€”</strong>
        <span class="muted">ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤</span>
      </div>
      <div class="flex">
        <button id="logout-btn" class="small ghost">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <!-- ì‹œê°„í‘œ -->
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:320px">
        <h3>ì‹œê°„í‘œ</h3>
        <div id="timetable"></div>
      </div>

      <!-- ìº˜ë¦°ë” / ë§ˆìŒì˜¨ë„ -->
      <div style="min-width:360px">
        <h3>ìº˜ë¦°ë” & ë§ˆìŒì˜¨ë„</h3>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <button id="prev-month" class="small">â—€ ì´ì „</button>
          <div id="calendar-month" class="muted"></div>
          <button id="next-month" class="small">ë‹¤ìŒ â–¶</button>
        </div>
        <div style="display:flex;gap:14px">
          <div class="calendar" id="calendar"></div>
          <div style="flex:1">
            <div id="mood-panel"><div class="muted">í–‰ì‚¬ë¥¼ í´ë¦­í•˜ë©´ ë§ˆìŒì˜¨ë„ë¥¼ ìµëª…ìœ¼ë¡œ ì œì¶œí•  ìˆ˜ ìˆì–´ìš”.</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ì…”í‹€ë²„ìŠ¤ -->
  <section class="card">
    <h3>ì…”í‹€ë²„ìŠ¤ ì •ë³´</h3>
    <div id="bus-list" class="muted"></div>
  </section>

  <!-- ëŒ€ë‚˜ë¬´ìˆ² ì‹œì‘ (ë²„íŠ¼ë§Œ) -->
  <section class="card">
    <h3>ëŒ€ë‚˜ë¬´ìˆ²</h3>
    <div class="flex" style="justify-content:space-between;align-items:center">
      <div class="muted">í•™êµ êµ¬ì„±ì›ë“¤ì´ ìµëª…ìœ¼ë¡œ ê¸€ì„ ì“°ëŠ” ê²Œì‹œíŒì…ë‹ˆë‹¤.</div>
      <div>
        <button id="open-bamboo-btn" class="small">ëŒ€ë‚˜ë¬´ìˆ² ê²Œì‹œíŒ â€¢ ìì„¸íˆ ë³´ê¸°</button>
      </div>
    </div>
  </section>
</section>

<!-- ëŒ€ë‚˜ë¬´ìˆ² ìƒì„¸ í˜ì´ì§€ (ë³„ë„ ì˜ì—­) -->
<section id="bamboo-page" class="card" style="display:none">
  <div style="display:flex;align-items:center;justify-content:space-between">
    <h2 style="margin:0">ëŒ€ë‚˜ë¬´ìˆ² ê²Œì‹œíŒ</h2>
    <div>
      <button id="bamboo-write-show" class="small">ê¸€ì“°ê¸°</button>
      <button id="bamboo-back" class="small ghost">ëŒì•„ê°€ê¸°</button>
    </div>
  </div>

  <!-- ê¸€ì“°ê¸° ì˜ì—­ (ì˜¤ë¥¸ìª½ ìƒë‹¨ ëˆ„ë¥´ë©´ ë³´ì„) -->
  <div id="bamboo-write-area" style="display:none;margin-top:12px;border-radius:8px;padding:10px;background:#fbfdff;border:1px solid #e6f0ff">
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="post-title" placeholder="ì œëª©" style="flex:2">
      <input id="post-file" type="file" style="flex:1">
    </div>
    <textarea id="post-content" rows="4" placeholder="ë‚´ìš©" style="width:100%;"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="post-submit" class="small">ì‘ì„±</button>
      <button id="post-cancel" class="small ghost">ì·¨ì†Œ</button>
    </div>
    <div id="file-preview" class="file-preview"></div>
  </div>

  <!-- ê²€ìƒ‰ -->
  <div style="display:flex;gap:8px;align-items:center;margin-top:12px;margin-bottom:8px">
    <div class="search-row">
      <input id="bamboo-search" placeholder="ì œëª© / ë‚´ìš© ê²€ìƒ‰(ë¶€ë¶„ê²€ìƒ‰ ê°€ëŠ¥)" style="width:360px">
      <select id="bamboo-search-type" style="width:120px">
        <option value="both">ì œëª©+ë‚´ìš©</option>
        <option value="title">ì œëª©ë§Œ</option>
        <option value="content">ë‚´ìš©ë§Œ</option>
      </select>
      <button id="bamboo-search-btn" class="small">ê²€ìƒ‰</button>
      <button id="bamboo-clear-search" class="small ghost">ì´ˆê¸°í™”</button>
    </div>
    <div class="muted" style="margin-left:auto">ì´ <span id="bamboo-total">0</span>ê°œ</div>
  </div>

  <!-- ëª©ë¡ (í…Œì´ë¸”, 20ê°œ/í˜ì´ì§€) -->
  <div class="table-scroll">
    <table>
      <thead>
        <tr><th style="width:12%">ì´ë¦„</th><th>ì œëª©</th><th style="width:18%">ì‘ì„±ì¼</th><th style="width:10%">ì¡°íšŒìˆ˜</th></tr>
      </thead>
      <tbody id="bamboo-list-body"></tbody>
    </table>
  </div>

  <div class="pagination" id="bamboo-pagination"></div>

  <!-- ê¸€ë³´ê¸° ì˜ì—­ -->
  <div id="bamboo-view-area" style="display:none;margin-top:12px;padding:12px;border-radius:8px;background:#fff;border:1px solid #eef4fb">
    <h3 id="view-title"></h3>
    <div class="muted" style="margin-bottom:8px">ì‘ì„±ì¼: <span id="view-date"></span> Â· ì¡°íšŒìˆ˜: <span id="view-views"></span></div>
    <div id="view-content" style="white-space:pre-wrap"></div>
    <div id="view-file-area"></div>

    <!-- ëŒ“ê¸€ì˜ì—­ -->
    <div class="comment-section">
      <h4 style="margin:8px 0">ëŒ“ê¸€</h4>
      <div style="display:flex;gap:8px">
        <input id="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" style="flex:1">
        <button id="comment-submit" class="small">ì‘ì„±</button>
      </div>
      <div id="comment-list-area" style="margin-top:10px"></div>
      <div class="comment-pagination" id="comment-pagination"></div>
    </div>

    <!-- ì¶”ì²œ/ë¹„ì¶”ì²œ -->
    <div class="center-area" style="margin-top:12px">
      <button id="like-btn" class="small">ğŸ‘ ì¶”ì²œ</button>
      <button id="dislike-btn" class="small">ğŸ‘ ë¹„ì¶”ì²œ</button>
      <div style="margin-top:8px">ì¶”ì²œ: <span id="view-likes">0</span> Â· ë¹„ì¶”ì²œ: <span id="view-dislikes">0</span></div>
      <div style="margin-top:8px"><button id="close-view" class="small ghost">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button></div>
    </div>
  </div>
</section>

<script>
/* ==== ì•ˆì „í•œ localStorage íŒŒì‹± ==== */
function safeLoad(key, fallback){
  try{ const v = localStorage.getItem(key); return v? JSON.parse(v): fallback; } catch(e){ return fallback; }
}
function safeSave(key, obj){ try{ localStorage.setItem(key, JSON.stringify(obj)); } catch(e){ console.warn('localStorage save failed', e); } }

/* ===== ì´ˆê¸° ë°ì´í„°/ìƒíƒœ ===== */
let users = safeLoad('users', []);
// ì´ˆê¸°í™” ìš”êµ¬í•˜ì…¨ë˜ ì  ë°˜ì˜: í…ŒìŠ¤íŠ¸ìš© ê¸°ë³¸ ê³„ì • ì‚½ì… (ë§Œì•½ ì²˜ìŒ ì €ì¥ëœ usersê°€ ì—†ì„ ë•Œ)
if(!Array.isArray(users) || users.length===0){ users = [{id:'test', password:'1234', grade:2, class:7}]; safeSave('users', users); }
let currentUser = safeLoad('currentUser', null);
let moodsData = safeLoad('moods', {}); // { "YYYY-MM-DD": { "ğŸ˜„":n, "ğŸ˜“":n, ... } }
let bambooPosts = safeLoad('bamboo', []); // array of posts
// bamboo post structure: {id:number,title,content,fileName,fileData,date,views,likes,dislikes,comments: [{text,date}], authorName:'ìµëª…'}

const POSTS_PER_PAGE = 20;
const COMMENTS_PER_PAGE = 10;

/* ===== DOM elements bind & utils ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  // auth
  document.getElementById('login-btn').addEventListener('click', onLogin);
  document.getElementById('show-signup-btn').addEventListener('click', ()=>{ document.getElementById('login-panel').style.display='none'; document.getElementById('signup-panel').style.display='block'; });
  document.getElementById('hide-signup-btn').addEventListener('click', ()=>{ document.getElementById('signup-panel').style.display='none'; document.getElementById('login-panel').style.display='block'; });
  document.getElementById('signup-btn').addEventListener('click', onSignup);
  document.getElementById('logout-btn').addEventListener('click', onLogout);

  // calendar controls
  document.getElementById('prev-month').addEventListener('click', ()=>{ changeMonth(-1); });
  document.getElementById('next-month').addEventListener('click', ()=>{ changeMonth(1); });

  // bus & bamboo
  document.getElementById('open-bamboo-btn').addEventListener('click', ()=>{ openBambooPage(); });
  document.getElementById('bamboo-back').addEventListener('click', ()=>{ closeBambooPage(); });
  document.getElementById('bamboo-write-show').addEventListener('click', ()=>{ document.getElementById('bamboo-write-area').style.display='block'; });
  document.getElementById('post-cancel').addEventListener('click', ()=>{ document.getElementById('bamboo-write-area').style.display='none'; });
  document.getElementById('post-submit').addEventListener('click', onSubmitPost);
  document.getElementById('bamboo-search-btn').addEventListener('click', onSearch);
  document.getElementById('bamboo-clear-search').addEventListener('click', ()=>{ document.getElementById('bamboo-search').value=''; onSearch(); });

  // view/close
  document.getElementById('close-view').addEventListener('click', closePostView);
  document.getElementById('comment-submit').addEventListener('click', onSubmitComment);
  document.getElementById('like-btn').addEventListener('click', ()=>{ voteCurrent('likes'); });
  document.getElementById('dislike-btn').addEventListener('click', ()=>{ voteCurrent('dislikes'); });

  // load UI initial
  if(currentUser){ showPortalFor(currentUser); }
  renderBusList();
  renderBambooList();
  renderCalendar();
  updateTopUser();
});

/* ===== auth handlers ===== */
function onLogin(){
  const id = document.getElementById('login-id').value.trim();
  const pw = document.getElementById('login-pw').value;
  if(!id||!pw){ alert('ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
  const user = users.find(u=>u.id===id && u.password===pw);
  if(!user){ alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ í™•ì¸'); return; }
  currentUser = user;
  safeSave('currentUser', currentUser);
  showPortalFor(user);
}

function onSignup(){
  const id = document.getElementById('signup-id').value.trim();
  const pw = document.getElementById('signup-pw').value.trim();
  const grade = parseInt(document.getElementById('signup-grade').value);
  const cls = parseInt(document.getElementById('signup-class').value);
  if(!id||!pw|| isNaN(grade) || isNaN(cls)){ alert('ëª¨ë“  í•­ëª©ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”'); return; }
  if(grade<1||grade>3){ alert('í•™ë…„ì€ 1~3ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤'); return; }
  if(cls<1||cls>8){ alert('ë°˜ì€ 1~8ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤'); return; }
  if(users.some(u=>u.id===id)){ alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤'); return; }
  users.push({id, password:pw, grade, class:cls});
  safeSave('users', users);
  alert('íšŒì›ê°€ì… ì™„ë£Œ. ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
  document.getElementById('signup-panel').style.display='none';
  document.getElementById('login-panel').style.display='block';
}

function onLogout(){
  currentUser = null;
  localStorage.removeItem('currentUser');
  // show auth card
  document.getElementById('portal').style.display='none';
  document.getElementById('auth-card').style.display='block';
  document.getElementById('top-user').textContent='ë¡œê·¸ì¸ í•„ìš”';
}

/* ===== portal show ===== */
function showPortalFor(user){
  document.getElementById('auth-card').style.display='none';
  document.getElementById('portal').style.display='block';
  document.getElementById('user-info').textContent = `${user.id} (${user.grade}í•™ë…„ ${user.class}ë°˜)`;
  document.getElementById('top-user').textContent = `${user.id}ë‹˜`;
  showTimetable(user);
  renderCalendar();
  renderBusList();
  renderBambooList();
}

/* ===== time table ===== */
const timetables = {};
for(let g=1; g<=3; g++){
  for(let c=1; c<=8; c++){
    // simple generated sample timetable so every class has something
    timetables[`${g}-${c}`] = [
      ["êµ­ì–´","ìˆ˜í•™","ì˜ì–´","ê³¼í•™","ì²´ìœ¡"],
      ["ì˜ì–´","ì—­ì‚¬","ìˆ˜í•™","ìŒì•…","ì²´ìœ¡"],
      ["ê³¼í•™","êµ­ì–´","ë¯¸ìˆ ","ì²´ìœ¡","ì˜ì–´"],
      ["ìˆ˜í•™","ê³¼í•™","ì²´ìœ¡","ì˜ì–´","ìŒì•…"],
      ["ì²´ìœ¡","ì˜ì–´","ì—­ì‚¬","ë¯¸ìˆ ","ê³¼í•™"]
    ];
  }
}

function showTimetable(user){
  const key = `${user.grade}-${user.class}`;
  const container = document.getElementById('timetable'); container.innerHTML='';
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  thead.innerHTML = '<tr><th>êµì‹œ</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th></tr>';
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  for(let i=0;i<5;i++){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}êµì‹œ</td>` + timetables[key][i].map(sub=>`<td>${sub}</td>`).join('');
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  container.appendChild(table);
}

/* ===== shuttle bus ===== */
function renderBusList(){
  const el = document.getElementById('bus-list'); el.innerHTML='';
  buses.forEach(b=>{
    const div = document.createElement('div'); div.textContent = `${b.route} â€” ${b.status} (ë‹¤ìŒ: ${b.next})`;
    el.appendChild(div);
  });
}

/* ===== calendar & mood (anonymous) ===== */
const events = safeLoad('events', [{date:"2025-09-05",title:"ì²´ìœ¡ëŒ€íšŒ"},{date:"2025-09-10",title:"ê³¼í•™ì „ì‹œíšŒ"}]);
function renderCalendar(){
  const cal = document.getElementById('calendar'); cal.innerHTML='';
  const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
  document.getElementById('calendar-month').textContent = `${y}ë…„ ${m+1}ì›”`;
  const firstDay = new Date(y,m,1).getDay();
  const lastDate = new Date(y,m+1,0).getDate();
  for(let i=0;i<firstDay;i++){ const d=document.createElement('div'); d.className='day'; d.style.visibility='hidden'; cal.appendChild(d); }
  for(let d=1; d<=lastDate; d++){
    const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const cell = document.createElement('div');
    cell.className='day';
    cell.textContent = d;
    const evt = events.find(e=>e.date===dateStr);
    if(evt){
      cell.classList.add('event');
      cell.title = evt.title;
      cell.addEventListener('click', ()=>{ openMoodPanel(dateStr, evt.title); });
    }
    cal.appendChild(cell);
  }
}

function changeMonth(dir){
  currentMonth.setMonth(currentMonth.getMonth()+dir);
  renderCalendar();
}

/* mood: anonymous emoji voting (counts only) */
const EMOJIS = ["ğŸ˜„","ğŸ˜“","ğŸ˜","ğŸ˜¢"];
function openMoodPanel(dateStr, title){
  const panel = document.getElementById('mood-panel'); panel.innerHTML = `<h4>${dateStr} Â· ${title}</h4>`;
  const info = document.createElement('div'); info.className='muted'; info.textContent = 'ê°ì •ì„ ì´ëª¨ì§€ë¡œ ì„ íƒí•˜ì„¸ìš” (ìµëª…)';
  panel.appendChild(info);
  const btnRow = document.createElement('div'); btnRow.style.marginTop='8px';
  EMOJIS.forEach(e=>{
    const b = document.createElement('button'); b.className='small'; b.style.marginRight='6px'; b.textContent=e;
    b.addEventListener('click', ()=>{
      // record anonymous vote: increment counts
      moodsData[dateStr] = moodsData[dateStr] || {};
      moodsData[dateStr][e] = (moodsData[dateStr][e] || 0) + 1;
      safeSave('moods', moodsData);
      // show confirmation and only show total participants; per requirement, detailed breakdown only shown on "ë”ë³´ê¸°"
      panel.innerHTML = `<div class="muted">ì‘ë‹µ ì™„ë£Œ â€” ê°ì‚¬í•©ë‹ˆë‹¤.</div>`;
      const total = Object.values(moodsData[dateStr]).reduce((a,b)=>a+b,0);
      const more = document.createElement('button'); more.textContent=`ë”ë³´ê¸° (${total}ëª…)`; more.className='small ghost'; more.style.marginLeft='8px';
      more.addEventListener('click', ()=>{ alert(EMOJIS.map(x=>`${x} ${moodsData[dateStr][x]||0}ê°œ`).join('\n')); });
      panel.appendChild(more);
    });
    btnRow.appendChild(b);
  });
  panel.appendChild(btnRow);
}

/* ===== bamboo (ê²Œì‹œíŒ) ===== */
/* helpers */
function uid(){ return Date.now() + Math.floor(Math.random()*1000); }

let currentListPage = 1;
let currentSearchTerm = '';
let currentSearchType = 'both';
let currentViewPostId = null;
let currentCommentPage = 1;

function openBambooPage(){
  document.getElementById('auth-card').style.display='none';
  document.getElementById('portal').style.display='none';
  document.getElementById('bamboo-page').style.display='block';
  renderBambooList();
}
function closeBambooPage(){
  document.getElementById('bamboo-page').style.display='none';
  document.getElementById('auth-card').style.display = currentUser ? 'none' : 'block';
  document.getElementById('portal').style.display = currentUser ? 'block' : 'none';
}

/* post submit with optional file (stores name & dataURL) */
document.getElementById('post-file') && document.getElementById('post-file').addEventListener('change', function(){
  const f = this.files[0];
  if(!f){ document.getElementById('file-preview').textContent=''; return; }
  document.getElementById('file-preview').textContent = `ì²¨ë¶€: ${f.name} (${Math.round(f.size/1024)} KB) â€” ì €ì¥ë©ë‹ˆë‹¤.`;
});

function onSubmitPost(){
  const title = document.getElementById('post-title').value.trim();
  const content = document.getElementById('post-content').value.trim();
  const fileInput = document.getElementById('post-file');
  if(!title || !content){ alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
  // handle file (async)
  if(fileInput && fileInput.files && fileInput.files[0]){
    const f = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = function(e){
      const dataURL = e.target.result;
      const post = { id: uid(), name:'ìµëª…', title, content, fileName: f.name, fileData: dataURL, date: new Date().toLocaleString(), views:0, likes:0, dislikes:0, comments:[] };
      bambooPosts.unshift(post); safeSave('bamboo', bambooPosts);
      // clear inputs
      document.getElementById('post-title').value=''; document.getElementById('post-content').value=''; fileInput.value='';
      document.getElementById('file-preview').textContent='';
      document.getElementById('bamboo-write-area').style.display='none';
      currentListPage = 1; renderBambooList();
    };
    reader.readAsDataURL(f);
  } else {
    const post = { id: uid(), name:'ìµëª…', title, content, fileName:'', fileData:'', date: new Date().toLocaleString(), views:0, likes:0, dislikes:0, comments:[] };
    bambooPosts.unshift(post); safeSave('bamboo', bambooPosts);
    document.getElementById('post-title').value=''; document.getElementById('post-content').value='';
    document.getElementById('bamboo-write-area').style.display='none';
    currentListPage = 1; renderBambooList();
  }
}

/* render list with search + pagination (20 per page) */
function renderBambooList(){
  const tbody = document.getElementById('bamboo-list-body'); tbody.innerHTML='';
  let filtered = bambooPosts.slice(); // copy
  const term = (currentSearchTerm || document.getElementById('bamboo-search').value || '').trim().toLowerCase();
  currentSearchType = document.getElementById('bamboo-search-type').value;
  if(term){
    filtered = filtered.filter(p=>{
      const t = p.title.toLowerCase(); const c = p.content.toLowerCase();
      if(currentSearchType==='title') return t.includes(term);
      if(currentSearchType==='content') return c.includes(term);
      return t.includes(term) || c.includes(term);
    });
  }
  const total = filtered.length;
  document.getElementById('bamboo-total').textContent = total;
  const pages = Math.max(1, Math.ceil(total / POSTS_PER_PAGE));
  if(currentListPage > pages) currentListPage = 1;
  const start = (currentListPage-1)*POSTS_PER_PAGE;
  const pageItems = filtered.slice(start, start + POSTS_PER_PAGE);
  pageItems.forEach(p=>{
    const tr = document.createElement('tr');
    // title clickable -> viewPost
    const titleLink = `<a href="#" data-id="${p.id}" class="post-link">${escapeHtml(p.title)}</a>`;
    tr.innerHTML = `<td>${escapeHtml(p.name)}</td><td>${titleLink}</td><td>${escapeHtml(p.date)}</td><td class="center">${p.views||0}</td>`;
    tbody.appendChild(tr);
  });
  // attach link listeners
  document.querySelectorAll('.post-link').forEach(a=>{
    a.addEventListener('click', (ev)=>{
      ev.preventDefault();
      const id = Number(ev.currentTarget.dataset.id);
      viewPost(id);
    });
  });
  // pagination controls
  const pag = document.getElementById('bamboo-pagination'); pag.innerHTML='';
  for(let i=1;i<=pages;i++){
    const b = document.createElement('button'); b.textContent = i; b.className='small';
    if(i===currentListPage) b.style.fontWeight='600';
    b.addEventListener('click', ()=>{ currentListPage=i; renderBambooList(); });
    pag.appendChild(b);
  }
}

/* escape HTML helper */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]); }); }

/* search handler */
function onSearch(){
  currentSearchTerm = document.getElementById('bamboo-search').value.trim();
  currentListPage = 1;
  renderBambooList();
}

/* view a post by id */
function viewPost(id){
  const idx = bambooPosts.findIndex(p=>p.id===id);
  if(idx===-1) return alert('ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
  currentViewPostId = id;
  // increment views
  bambooPosts[idx].views = (bambooPosts[idx].views||0) + 1;
  safeSave('bamboo', bambooPosts);
  // populate view area
  const post = bambooPosts[idx];
  document.getElementById('view-title').textContent = post.title;
  document.getElementById('view-date').textContent = post.date;
  document.getElementById('view-views').textContent = post.views;
  document.getElementById('view-content').textContent = post.content;
  document.getElementById('view-likes').textContent = post.likes||0;
  document.getElementById('view-dislikes').textContent = post.dislikes||0;
  // file
  const fileArea = document.getElementById('view-file-area'); fileArea.innerHTML = '';
  if(post.fileName && post.fileData){
    const a = document.createElement('a'); a.href = post.fileData; a.download = post.fileName; a.textContent = `ì²¨ë¶€: ${post.fileName}`; a.className='file-link';
    fileArea.appendChild(a);
  }
  // show view area
  document.getElementById('bamboo-view-area').style.display='block';
  // hide list area visually (table remains, but hide view area toggles)
  // render comments (page 1)
  currentCommentPage = 1;
  renderCommentsForPost(idx);
}

/* comments render with pagination 10 per page */
function renderCommentsForPost(postIndex){
  const area = document.getElementById('comment-list-area'); area.innerHTML='';
  const post = bambooPosts[postIndex];
  const comments = post.comments || [];
  const totalPages = Math.max(1, Math.ceil(comments.length / COMMENTS_PER_PAGE));
  if(currentCommentPage>totalPages) currentCommentPage = 1;
  const start = (currentCommentPage-1)*COMMENTS_PER_PAGE;
  const pageItems = comments.slice(start, start + COMMENTS_PER_PAGE);
  pageItems.forEach(c=>{
    const div = document.createElement('div'); div.className='comment'; div.textContent = `${c.date} â€” ${c.text}`; area.appendChild(div);
  });
  // comment pagination buttons
  const pg = document.getElementById('comment-pagination'); pg.innerHTML='';
  for(let i=1;i<=totalPages;i++){
    const b = document.createElement('button'); b.textContent=i; b.className='small';
    if(i===currentCommentPage) b.style.fontWeight='600';
    b.addEventListener('click', ()=>{ currentCommentPage = i; renderCommentsForPost(postIndex); });
    pg.appendChild(b);
  }
}

/* post comment */
function onSubmitComment(){
  if(currentViewPostId===null){ alert('ê²Œì‹œê¸€ì„ ì„ íƒí•˜ì„¸ìš”'); return; }
  const text = document.getElementById('comment-input').value.trim();
  if(!text) return;
  const idx = bambooPosts.findIndex(p=>p.id===currentViewPostId);
  if(idx===-1) return alert('ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
  const entry = { text, date: new Date().toLocaleString() };
  bambooPosts[idx].comments = bambooPosts[idx].comments || [];
  bambooPosts[idx].comments.push(entry);
  safeSave('bamboo', bambooPosts);
  document.getElementById('comment-input').value='';
  // jump to last page where the new comment is
  const totalComments = bambooPosts[idx].comments.length;
  currentCommentPage = Math.ceil(totalComments / COMMENTS_PER_PAGE);
  renderCommentsForPost(idx);
}

/* like/dislike */
function voteCurrent(field){
  if(currentViewPostId===null) return;
  const idx = bambooPosts.findIndex(p=>p.id===currentViewPostId);
  if(idx===-1) return;
  bambooPosts[idx][field] = (bambooPosts[idx][field]||0) + 1;
  safeSave('bamboo', bambooPosts);
  document.getElementById('view-likes').textContent = bambooPosts[idx].likes||0;
  document.getElementById('view-dislikes').textContent = bambooPosts[idx].dislikes||0;
}

/* close post view */
function closePostView(){
  // hide view area
  document.getElementById('bamboo-view-area').style.display='none';
  currentViewPostId = null;
  // refresh list (views count maybe changed)
  renderBambooList();
}

/* helper: open bamboo write area */
function showBambooWrite(){ document.getElementById('bamboo-write-area').style.display='block'; }
function hideBambooWrite(){ document.getElementById('bamboo-write-area').style.display='none'; }

/* initial render helpers */
function renderBambooListInitial(){
  // ensure UI shows list (hide view)
  document.getElementById('bamboo-view-area').style.display='none';
  renderBambooList();
}

/* utility: open bamboo page from portal button */
function openBambooPage(){
  openBambooPage = window.openBambooPage || openBambooPage;
  // fallback defined above
}

/* ===== initial UI sync ===== */
function updateTopUser(){
  if(currentUser) document.getElementById('top-user').textContent = `${currentUser.id} (${currentUser.grade}í•™ë…„ ${currentUser.class}ë°˜)`;
  else document.getElementById('top-user').textContent = 'ë¡œê·¸ì¸ í•„ìš”';
}

/* ===== ensure calendar & bamboo display on load if logged in ===== */
if(currentUser){
  document.getElementById('auth-card').style.display='none';
  document.getElementById('portal').style.display='block';
  updateTopUser();
}

/* expose some functions used inline */
window.openBambooPage = function(){ openBambooPage(); };
window.showBambooDetail = function(){ openBambooPage(); };

/* final render */
renderCalendar();
renderBambooList();

</script>
</div>
</body>
</html>
