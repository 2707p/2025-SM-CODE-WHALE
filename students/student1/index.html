cd backend
npm init -y
npm install express bcrypt jsonwebtoken pg cors dotenv
const { Pool } = require("pg");
require("dotenv").config();

const pool = new Pool({
  connectionString: process.env.DB_URL,
});

module.exports = pool;
const express = require("express");
const jwt = require("jsonwebtoken");
const bcrypt = require("bcrypt");
const db = require("../db");
const router = express.Router();

// 로그인
router.post("/login", async (req, res) => {
  const { studentId, password } = req.body;
  const result = await db.query("SELECT * FROM students WHERE student_id=$1", [studentId]);
  if (!result.rows.length) return res.status(401).json({ error: "학생 없음" });

  const student = result.rows[0];
  const valid = await bcrypt.compare(password, student.password_hash);
  if (!valid) return res.status(401).json({ error: "비밀번호 불일치" });

  const token = jwt.sign({ studentId }, process.env.JWT_SECRET, { expiresIn: "2h" });
  res.json({ token, mustChangePassword: student.must_change_password });
});

// 비밀번호 변경
router.post("/change-password", async (req, res) => {
  const { studentId, oldPassword, newPassword } = req.body;
  const result = await db.query("SELECT * FROM students WHERE student_id=$1", [studentId]);
  if (!result.rows.length) return res.status(401).json({ error: "학생 없음" });

  const student = result.rows[0];
  const valid = await bcrypt.compare(oldPassword, student.password_hash);
  if (!valid) return res.status(401).json({ error: "기존 비밀번호 불일치" });

  const newHash = await bcrypt.hash(newPassword, 10);
  await db.query(
    "UPDATE students SET password_hash=$1, must_change_password=false WHERE student_id=$2",
    [newHash, studentId]
  );

  res.json({ message: "비밀번호 변경 성공 ✅" });
});

module.exports = router;
const express = require("express");
const cors = require("cors");
require("dotenv").config();

const app = express();
app.use(cors());
app.use(express.json());

// 라우트 등록
const authRoutes = require("./routes/auth");
app.use("/api/auth", authRoutes);

const PORT = process.env.PORT || 4000;
app.listen(PORT, () => console.log(`✅ Backend running on port ${PORT}`));
JWT_SECRET=supersecret
DB_URL=postgresql://postgres:비번@localhost:5432/schooldb
CREATE DATABASE schooldb;

\c schooldb;

CREATE TABLE students (
  id SERIAL PRIMARY KEY,
  student_id VARCHAR(20) UNIQUE NOT NULL,
  name VARCHAR(50) NOT NULL,
  password_hash TEXT NOT NULL,
  must_change_password BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
);

-- 테스트 계정
INSERT INTO students (student_id, name, password_hash)
VALUES ('20250001', '홍길동', crypt('1234', gen_salt('bf')));
