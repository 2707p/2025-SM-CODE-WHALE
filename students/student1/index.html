<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>ì„±ë¯¼ì—¬ê³  í¬í„¸ - í†µí•© (ëŒ€ë‚˜ë¬´ìˆ²: ê¸€ìƒì„¸ ë³„ë„í˜ì´ì§€)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{--bg:#f6f9fc;--card:#fff;--accent:#2b7cff;--muted:#6c7885}
  body{font-family:Arial, sans-serif;background:var(--bg);margin:0;padding:20px;color:#102027}
  .wrap{max-width:1100px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  h1{margin:0;font-size:20px;color:#0b3b66}
  .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(10,20,40,0.06);margin-bottom:14px}
  .flex{display:flex;gap:8px;align-items:center}
  input, textarea, select, button{font-family:inherit}
  input[type="text"], input[type="password"], input[type="number"], textarea, select{
    padding:8px;border-radius:6px;border:1px solid #e1edf8;background:#fff;box-sizing:border-box;
  }
  button{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
  button.ghost{background:#fff;color:var(--accent);border:1px solid #e1edf8}
  table{width:100%;border-collapse:collapse}
  ul{padding-left:0}
  li{list-style:none}
  .muted{color:var(--muted);font-size:13px}
  .calendar{display:flex;flex-wrap:wrap;width:320px}
  .day{width:40px;height:40px;margin:3px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid #e6f3fb;cursor:pointer}
  .day.event{background:#f39c12;color:#fff;border:none}
  .pagination{display:flex;gap:6px;justify-content:center;margin-top:12px}
  .title-list{padding-left:0}
  .title-item{padding:8px 6px;cursor:pointer;border-radius:6px}
  .title-item:hover{background:#f0f6ff}
  .center{ text-align:center }
  .file-link{color:#1765d8;text-decoration:underline;cursor:pointer}
  .note{font-size:13px;color:var(--muted)}
  .badge{background:#eef6ff;color:#1765d8;padding:3px 8px;border-radius:999px;font-size:12px}
  .hidden{display:none}
</style>
</head>
<body>
<div class="wrap">

<header>
  <h1>ì°½ì› ì„±ë¯¼ì—¬ìê³ ë“±í•™êµ í¬í„¸</h1>
  <div id="top-user" class="muted">ë¡œê·¸ì¸ í•„ìš”</div>
</header>

<!-- ì¸ì¦ ì¹´ë“œ -->
<section id="auth-card" class="card">
  <div id="login-panel">
    <h2 style="margin:0 0 8px 0">ë¡œê·¸ì¸</h2>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="login-id" placeholder="ì•„ì´ë”” (ì˜ˆ: test)" style="max-width:200px">
      <input id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" type="password" style="max-width:200px">
      <button id="login-btn">ë¡œê·¸ì¸</button>
      <button id="open-signup" class="ghost">íšŒì›ê°€ì…</button>
    </div>
    <p class="note" style="margin-top:8px">í…ŒìŠ¤íŠ¸ ê³„ì •: <strong>test / 1234</strong> (2í•™ë…„ 7ë°˜)</p>
  </div>

  <div id="signup-panel" class="hidden">
    <h2 style="margin:0 0 8px 0">íšŒì›ê°€ì…</h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <input id="signup-id" placeholder="ì•„ì´ë””">
      <input id="signup-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" type="password">
      <input id="signup-grade" placeholder="í•™ë…„ (1~3)" type="number" min="1" max="3">
      <input id="signup-class" placeholder="ë°˜ (1~8)" type="number" min="1" max="8">
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="signup-btn">ê°€ì…í•˜ê¸°</button>
      <button id="cancel-signup" class="ghost">ì·¨ì†Œ</button>
    </div>
  </div>
</section>

<!-- í¬í„¸ (hidden until logged in) -->
<section id="portal" class="hidden">

  <div class="card" style="margin-bottom:12px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong id="user-info">â€”</strong> <span class="muted">ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤</span></div>
      <div class="flex">
        <button id="logout-btn" class="ghost">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <div style="display:flex;gap:16px;flex-wrap:wrap;margin-top:12px">
      <!-- ì‹œê°„í‘œ -->
      <div style="min-width:320px;flex:1">
        <h3 style="margin:0 0 8px 0">ì‹œê°„í‘œ</h3>
        <div id="timetable"></div>
      </div>

      <!-- ìº˜ë¦°ë” & ë§ˆìŒì˜¨ë„ -->
      <div style="min-width:360px">
        <h3 style="margin:0 0 8px 0">ìº˜ë¦°ë” & ë§ˆìŒì˜¨ë„</h3>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <button id="prev-month" class="ghost">â—€ ì´ì „</button>
          <div id="calendar-month" class="muted"></div>
          <button id="next-month" class="ghost">ë‹¤ìŒ â–¶</button>
        </div>
        <div style="display:flex;gap:12px">
          <div class="calendar" id="calendar"></div>
          <div style="flex:1">
            <div id="mood-panel"><div class="muted">í–‰ì‚¬ë¥¼ í´ë¦­í•˜ë©´ ìµëª…ìœ¼ë¡œ ê°ì •(ì´ëª¨ì§€)ì„ ì œì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- ì…”í‹€ë²„ìŠ¤ -->
  <section class="card">
    <h3 style="margin:0 0 8px 0">ì…”í‹€ë²„ìŠ¤ ì •ë³´</h3>
    <div id="bus-list" class="muted"></div>
  </section>

  <!-- ëŒ€ë‚˜ë¬´ìˆ² ê°„ë‹¨ ë²„íŠ¼ -->
  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="muted">ìµëª… ê²Œì‹œíŒ â€” ë¬¸ì œë‚˜ ê³ ë¯¼ì„ ë‚˜ëˆŒ ìˆ˜ ìˆì–´ìš”.</div>
      <div>
        <button id="open-bamboo" class="">ëŒ€ë‚˜ë¬´ìˆ² ê²Œì‹œíŒ â€¢ ìì„¸íˆ ë³´ê¸°</button>
      </div>
    </div>
  </section>

</section>

<!-- ëŒ€ë‚˜ë¬´ìˆ² ìƒì„¸ í˜ì´ì§€ (ëª©ë¡) -->
<section id="bamboo-list-page" class="card hidden">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h2 style="margin:0">ëŒ€ë‚˜ë¬´ìˆ²</h2>
    <div class="flex">
      <button id="bamboo-write-btn" class="">ê¸€ì“°ê¸°</button>
      <button id="bamboo-close" class="ghost">ëŒì•„ê°€ê¸°</button>
    </div>
  </div>

  <!-- write area (toggle) -->
  <div id="bamboo-write-area" class="hidden" style="margin-top:10px;padding:10px;border-radius:8px;background:#fbfdff;border:1px solid #e6f0ff">
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="post-title" placeholder="ì œëª©" style="flex:1">
      <input id="post-file" type="file" style="width:200px">
    </div>
    <textarea id="post-content" rows="4" placeholder="ë‚´ìš©" style="width:100%"></textarea>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
      <button id="post-submit">ì‘ì„±</button>
      <button id="post-cancel" class="ghost">ì·¨ì†Œ</button>
    </div>
    <div id="file-preview" class="note"></div>
  </div>

  <!-- search -->
  <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
    <input id="bamboo-search" placeholder="ì œëª© ë˜ëŠ” ë‚´ìš©ìœ¼ë¡œ ê²€ìƒ‰" style="flex:1">
    <select id="bamboo-search-type">
      <option value="both">ì œëª©+ë‚´ìš©</option>
      <option value="title">ì œëª©ë§Œ</option>
      <option value="content">ë‚´ìš©ë§Œ</option>
    </select>
    <button id="bamboo-search-btn" class="ghost">ê²€ìƒ‰</button>
    <button id="bamboo-clear-search" class="ghost">ì´ˆê¸°í™”</button>
  </div>

  <!-- title-only list (no table borders, just titles) -->
  <ul id="bamboo-titles" class="title-list" style="margin-top:12px"></ul>

  <!-- posts pagination (20 per page) -->
  <div class="pagination" id="bamboo-pagination"></div>
</section>

<!-- ê°œë³„ ê¸€ ìƒì„¸ í˜ì´ì§€ (ë³„ë„ ì„¹ì…˜ì²˜ëŸ¼ ë³´ì„) -->
<section id="bamboo-post-page" class="card hidden">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div>
      <h2 id="post-view-title" style="margin:0"></h2>
      <div class="muted" id="post-meta" style="margin-top:6px">ì‘ì„±ì: ìµëª… Â· ì‘ì„±ì¼: <span id="post-date"></span> Â· ì¡°íšŒìˆ˜: <span id="post-views"></span></div>
    </div>
    <div class="flex">
      <button id="post-back" class="ghost">ëª©ë¡ìœ¼ë¡œ</button>
    </div>
  </div>

  <div id="post-body" style="margin-top:12px;white-space:pre-wrap"></div>
  <div id="post-file-area" style="margin-top:8px"></div>

  <!-- comments -->
  <div style="margin-top:12px;border-top:1px solid #eef3f8;padding-top:12px">
    <h4 style="margin:0 0 8px 0">ëŒ“ê¸€</h4>
    <div style="display:flex;gap:8px">
      <input id="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" style="flex:1">
      <button id="comment-submit">ì‘ì„±</button>
    </div>
    <div id="comment-list" style="margin-top:10px"></div>
    <div class="pagination" id="comment-pagination"></div>
  </div>

  <!-- like/dislike -->
  <div class="center" style="margin-top:12px">
    <button id="like-btn">ğŸ‘ ì¶”ì²œ</button>
    <button id="dislike-btn">ğŸ‘ ë¹„ì¶”ì²œ</button>
    <div style="margin-top:8px">ì¶”ì²œ: <span id="post-likes">0</span> Â· ë¹„ì¶”ì²œ: <span id="post-dislikes">0</span></div>
  </div>
</section>

</div>

<script>
/* ---------- ì•ˆì „í•œ storage helper ---------- */
function safeLoad(key, fallback){
  try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch(e){ return fallback; }
}
function safeSave(key, value){ try{ localStorage.setItem(key, JSON.stringify(value)); } catch(e){ console.warn('save fail', e); } }

/* ---------- ì´ˆê¸° ë°ì´í„° & ìƒíƒœ ---------- */
let users = safeLoad('users', []);
if(!Array.isArray(users) || users.length===0){
  users = [{id:'test', password:'1234', grade:2, class:7}];
  safeSave('users', users);
}
let currentUser = safeLoad('currentUser', null);
let moodsData = safeLoad('moods', {}); // { 'YYYY-MM-DD': { 'ğŸ˜„': n, ... } }
let bamboo = safeLoad('bamboo', []); // posts array
// post structure: { id, title, content, fileName, fileData, date, views, likes, dislikes, comments:[{text,date}] }

const POSTS_PER_PAGE = 20;
const COMMENTS_PER_PAGE = 10;

/* ---------- DOM bindings & events ---------- */
document.addEventListener('DOMContentLoaded', ()=>{

  // auth
  document.getElementById('login-btn').addEventListener('click', onLogin);
  document.getElementById('open-signup').addEventListener('click', ()=>{ document.getElementById('login-panel').classList.add('hidden'); document.getElementById('signup-panel').classList.remove('hidden');});
  document.getElementById('cancel-signup').addEventListener('click', ()=>{ document.getElementById('signup-panel').classList.add('hidden'); document.getElementById('login-panel').classList.remove('hidden');});
  document.getElementById('signup-btn').addEventListener('click', onSignup);
  document.getElementById('logout-btn').addEventListener('click', onLogout);

  // calendar controls
  document.getElementById('prev-month').addEventListener('click', ()=>{ changeMonth(-1); });
  document.getElementById('next-month').addEventListener('click', ()=>{ changeMonth(1); });

  // shuttle & bamboo open
  document.getElementById('open-bamboo').addEventListener('click', openBambooList);
  document.getElementById('bamboo-close').addEventListener('click', closeBambooList);

  // write area controls
  document.getElementById('bamboo-write-btn').addEventListener('click', ()=>{ document.getElementById('bamboo-write-area').classList.toggle('hidden'); });
  document.getElementById('post-cancel').addEventListener('click', ()=>{ document.getElementById('bamboo-write-area').classList.add('hidden'); document.getElementById('file-preview').textContent=''; });
  document.getElementById('post-submit').addEventListener('click', onSubmitPost);
  document.getElementById('post-file').addEventListener('change', onFileSelected);

  // search
  document.getElementById('bamboo-search-btn').addEventListener('click', ()=>{ currentListPage = 1; renderBambooList(); });
  document.getElementById('bamboo-clear-search').addEventListener('click', ()=>{ document.getElementById('bamboo-search').value=''; renderBambooList(); });

  // post page controls
  document.getElementById('post-back').addEventListener('click', ()=>{ closePostPage(); });
  document.getElementById('post-close')?.addEventListener('click', ()=>{ closeBambooList(); });
  document.getElementById('comment-submit').addEventListener('click', onSubmitComment);
  document.getElementById('like-btn').addEventListener('click', ()=>{ vote('likes'); });
  document.getElementById('dislike-btn').addEventListener('click', ()=>{ vote('dislikes'); });

  // UI initial
  if(currentUser){ showPortalFor(currentUser); } else { document.getElementById('auth-card').classList.remove('hidden'); }
  renderCalendar();
  renderBus();
  renderBambooList();
  updateTopUser();
});

/* ---------- AUTH handlers ---------- */
function onLogin(){
  const id = document.getElementById('login-id').value.trim();
  const pw = document.getElementById('login-pw').value;
  if(!id || !pw){ alert('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
  users = safeLoad('users', users);
  const u = users.find(x=>x.id===id && x.password===pw);
  if(!u){ alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ í™•ì¸'); return; }
  currentUser = u; safeSave('currentUser', currentUser);
  showPortalFor(u);
}
function onSignup(){
  const id = document.getElementById('signup-id').value.trim();
  const pw = document.getElementById('signup-pw').value;
  const grade = parseInt(document.getElementById('signup-grade').value);
  const cls = parseInt(document.getElementById('signup-class').value);
  if(!id||!pw||isNaN(grade)||isNaN(cls)){ alert('ëª¨ë“  í•­ëª©ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”'); return; }
  if(grade<1||grade>3 || cls<1||cls>8){ alert('í•™ë…„:1~3 / ë°˜:1~8ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤'); return; }
  users.push({id, password:pw, grade, class:cls});
  safeSave('users', users);
  alert('ê°€ì… ì™„ë£Œ. ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
  document.getElementById('signup-panel').classList.add('hidden');
  document.getElementById('login-panel').classList.remove('hidden');
}
function onLogout(){
  currentUser = null; localStorage.removeItem('currentUser');
  document.getElementById('portal').classList.add('hidden');
  document.getElementById('auth-card').classList.remove('hidden');
  updateTopUser();
}

/* ---------- show portal ---------- */
function showPortalFor(user){
  document.getElementById('auth-card').classList.add('hidden');
  document.getElementById('portal').classList.remove('hidden');
  document.getElementById('user-info').textContent = `${user.id} (${user.grade}í•™ë…„ ${user.class}ë°˜)`;
  updateTopUser();
  showTimetable(user);
  renderCalendar();
  renderBus();
}

/* ---------- top-user ---------- */
function updateTopUser(){
  document.getElementById('top-user').textContent = currentUser ? `${currentUser.id} (${currentUser.grade}í•™ë…„ ${currentUser.class}ë°˜)` : 'ë¡œê·¸ì¸ í•„ìš”';
}

/* ---------- TIMETABLE ---------- */
const timetables = {};
for(let g=1; g<=3; g++){
  for(let c=1; c<=8; c++){
    timetables[`${g}-${c}`] = [
      ["êµ­ì–´","ìˆ˜í•™","ì˜ì–´","ê³¼í•™","ì²´ìœ¡"],
      ["ì˜ì–´","ì—­ì‚¬","ìˆ˜í•™","ìŒì•…","ì²´ìœ¡"],
      ["ê³¼í•™","êµ­ì–´","ë¯¸ìˆ ","ì²´ìœ¡","ì˜ì–´"],
      ["ìˆ˜í•™","ê³¼í•™","ì²´ìœ¡","ì˜ì–´","ìŒì•…"],
      ["ì²´ìœ¡","ì˜ì–´","ì—­ì‚¬","ë¯¸ìˆ ","ê³¼í•™"]
    ];
  }
}
function showTimetable(user){
  const key = `${user.grade}-${user.class}`;
  const container = document.getElementById('timetable'); container.innerHTML='';
  const table = document.createElement('table');
  const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>êµì‹œ</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th></tr>'; table.appendChild(thead);
  const tbody = document.createElement('tbody');
  for(let i=0;i<5;i++){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}êµì‹œ</td>` + timetables[key][i].map(s=>`<td>${s}</td>`).join('');
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  container.appendChild(table);
}

/* ---------- SHUTTLE BUSES ---------- */
const buses = [{route:"Aì½”ìŠ¤",status:"ìš´í–‰ì¤‘",next:"08:30"},{route:"Bì½”ìŠ¤",status:"ì§€ì—°",next:"08:45"}];
function renderBus(){ const el = document.getElementById('bus-list'); el.innerHTML=''; buses.forEach(b=>{ const d=document.createElement('div'); d.textContent=`${b.route} â€” ${b.status} (ë‹¤ìŒ: ${b.next})`; el.appendChild(d);} ); }

/* ---------- CALENDAR & MOOD ---------- */
let currentMonth = new Date();
const sampleEvents = safeLoad('events', [{date:"2025-09-05",title:"ì²´ìœ¡ëŒ€íšŒ"},{date:"2025-09-10",title:"ê³¼í•™ì „ì‹œíšŒ"}]);
function renderCalendar(){
  const cal = document.getElementById('calendar'); cal.innerHTML='';
  const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
  document.getElementById('calendar-month').textContent = `${y}ë…„ ${m+1}ì›”`;
  const first = new Date(y,m,1).getDay(), last = new Date(y,m+1,0).getDate();
  for(let i=0;i<first;i++){ const d = document.createElement('div'); d.className='day'; d.style.visibility='hidden'; cal.appendChild(d); }
  for(let d=1; d<=last; d++){
    const div = document.createElement('div'); div.className='day'; div.textContent = d;
    const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const evt = sampleEvents.find(e=>e.date===dateStr);
    if(evt){ div.classList.add('event'); div.title = evt.title; div.addEventListener('click', ()=> openMood(dateStr, evt.title)); }
    cal.appendChild(div);
  }
}
function changeMonth(dir){ currentMonth.setMonth(currentMonth.getMonth()+dir); renderCalendar(); }

const EMOJIS = ["ğŸ˜„","ğŸ˜“","ğŸ˜","ğŸ˜¢"];
function openMood(dateStr, title){
  const panel = document.getElementById('mood-panel'); panel.innerHTML = `<h4>${dateStr} Â· ${title}</h4>`;
  const info = document.createElement('div'); info.className='muted'; info.textContent = 'ê°ì •ì„ ì„ íƒ(ìµëª…)'; panel.appendChild(info);
  const row = document.createElement('div'); row.style.marginTop='8px';
  EMOJIS.forEach(e=>{
    const b = document.createElement('button'); b.textContent = e; b.style.marginRight='6px';
    b.addEventListener('click', ()=>{
      moodsData[dateStr] = moodsData[dateStr] || {};
      moodsData[dateStr][e] = (moodsData[dateStr][e]||0) + 1;
      safeSave('moods', moodsData);
      panel.innerHTML = `<div class="muted">ì‘ë‹µ ì™„ë£Œ â€” ê°ì‚¬í•©ë‹ˆë‹¤.</div>`;
      const total = Object.values(moodsData[dateStr]).reduce((a,b)=>a+b,0);
      const more = document.createElement('button'); more.textContent = `ë”ë³´ê¸° (${total}ëª…)`; more.className='ghost';
      more.addEventListener('click', ()=> alert(EMOJIS.map(x=>`${x} ${moodsData[dateStr][x]||0}ê°œ`).join('\n')));
      panel.appendChild(more);
    });
    row.appendChild(b);
  });
  panel.appendChild(row);
}

/* ---------- BAMBOO POSTS (list, post, search, paging) ---------- */
let currentListPage = 1;
let currentListFilter = { term:'', type:'both' };

function openBambooList(){ 
  // show list page
  document.getElementById('auth-card').classList.add('hidden');
  document.getElementById('portal').classList.add('hidden');
  document.getElementById('bamboo-list-page').classList.remove('hidden');
  document.getElementById('bamboo-post-page')?.classList.add('hidden');
  renderBambooList();
}
function closeBambooList(){
  document.getElementById('bamboo-list-page').classList.add('hidden');
  document.getElementById('bamboo-post-page')?.classList.add('hidden');
  document.getElementById('portal').classList.remove('hidden');
  document.getElementById('auth-card').classList.add(currentUser? 'hidden':'');
  updateTopUser();
}

/* file input preview */
function onFileSelected(e){
  const f = e.target.files[0];
  if(!f){ document.getElementById('file-preview').textContent=''; return; }
  document.getElementById('file-preview').textContent = `ì²¨ë¶€: ${f.name} (${Math.round(f.size/1024)} KB) â€” ì €ì¥ë©ë‹ˆë‹¤.`;
}

/* submit a new post (supports file) */
function onSubmitPost(){
  const title = document.getElementById('post-title').value.trim();
  const content = document.getElementById('post-content').value.trim();
  const fileInput = document.getElementById('post-file');
  if(!title||!content){ alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }

  function addPost(fileName='', fileData=''){
    const post = { id: Date.now() + Math.floor(Math.random()*1000), title, content, fileName, fileData, date: new Date().toLocaleString(), views:0, likes:0, dislikes:0, comments:[] };
    bamboo.unshift(post);
    safeSave('bamboo', bamboo);
    document.getElementById('post-title').value=''; document.getElementById('post-content').value=''; document.getElementById('post-file').value=''; document.getElementById('file-preview').textContent='';
    document.getElementById('bamboo-write-area').classList.add('hidden');
    currentListPage = 1;
    renderBambooList();
  }

  if(fileInput && fileInput.files && fileInput.files[0]){
    const f = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = function(ev){
      addPost(f.name, ev.target.result);
    };
    reader.readAsDataURL(f);
  } else {
    addPost('','');
  }
}

/* render bamboo titles list (title only) */
function renderBambooList(){
  const ul = document.getElementById('bamboo-titles'); ul.innerHTML='';
  // filter
  const term = (document.getElementById('bamboo-search').value || '').trim().toLowerCase();
  const type = document.getElementById('bamboo-search-type').value;
  let filtered = bamboo.slice();
  if(term){
    filtered = filtered.filter(p=>{
      const t = (p.title||'').toLowerCase();
      const c = (p.content||'').toLowerCase();
      if(type==='title') return t.includes(term);
      if(type==='content') return c.includes(term);
      return t.includes(term) || c.includes(term);
    });
  }
  const total = filtered.length;
  const pages = Math.max(1, Math.ceil(total / POSTS_PER_PAGE));
  if(currentListPage > pages) currentListPage = 1;
  const start = (currentListPage-1)*POSTS_PER_PAGE;
  const pageItems = filtered.slice(start, start+POSTS_PER_PAGE);
  pageItems.forEach(p=>{
    const li = document.createElement('li'); li.className='title-item';
    li.textContent = p.title;
    li.addEventListener('click', ()=> openPostPage(p.id));
    ul.appendChild(li);
  });
  // pagination
  const pag = document.getElementById('bamboo-pagination'); pag.innerHTML='';
  for(let i=1;i<=pages;i++){
    const b = document.createElement('button'); b.textContent = i;
    if(i===currentListPage) b.style.fontWeight='700';
    b.addEventListener('click', ()=>{ currentListPage = i; renderBambooList(); });
    pag.appendChild(b);
  }
}

/* ---------- Open single-post page (separate section-like view) ---------- */
let currentPostId = null;
function openPostPage(id){
  const idx = bamboo.findIndex(p=>p.id===id);
  if(idx === -1){ alert('ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
  // increment view
  bamboo[idx].views = (bamboo[idx].views||0) + 1; safeSave('bamboo', bamboo);
  currentPostId = id;

  // populate post page
  const post = bamboo[idx];
  document.getElementById('post-view-title').textContent = post.title;
  document.getElementById('post-meta').querySelector('#post-date')?.remove?.(); // ensure place
  document.getElementById('post-date').textContent = post.date;
  document.getElementById('post-views').textContent = post.views;
  document.getElementById('post-body').textContent = post.content;
  const fileArea = document.getElementById('post-file-area'); fileArea.innerHTML = '';
  if(post.fileName && post.fileData){
    const a = document.createElement('a'); a.href = post.fileData; a.download = post.fileName; a.className='file-link'; a.textContent = `ì²¨ë¶€: ${post.fileName}`;
    fileArea.appendChild(a);
  }
  document.getElementById('post-likes').textContent = post.likes || 0;
  document.getElementById('post-dislikes').textContent = post.dislikes || 0;

  // switch views: hide list page, show post page
  document.getElementById('bamboo-list-page').classList.add('hidden');
  document.getElementById('bamboo-post-page').classList.remove('hidden');
  // render comments (page 1)
  currentCommentPage = 1;
  renderComments();
}

/* close post page -> back to list */
function closePostPage(){
  currentPostId = null;
  document.getElementById('bamboo-post-page').classList.add('hidden');
  document.getElementById('bamboo-list-page').classList.remove('hidden');
  renderBambooList();
}

/* comments render & pagination */
let currentCommentPage = 1;
function renderComments(){
  if(!currentPostId) return;
  const idx = bamboo.findIndex(p=>p.id===currentPostId);
  if(idx===-1) return;
  const comments = bamboo[idx].comments || [];
  const totalPages = Math.max(1, Math.ceil(comments.length / COMMENTS_PER_PAGE));
  if(currentCommentPage > totalPages) currentCommentPage = 1;
  const start = (currentCommentPage - 1) * COMMENTS_PER_PAGE;
  const pageItems = comments.slice(start, start + COMMENTS_PER_PAGE);
  const wrap = document.getElementById('comment-list'); wrap.innerHTML = '';
  pageItems.forEach(c=>{
    const d = document.createElement('div'); d.className='card'; d.style.padding='8px'; d.style.marginBottom='6px';
    d.textContent = `${c.date} â€” ${c.text}`; wrap.appendChild(d);
  });
  // pagination
  const pg = document.getElementById('comment-pagination'); pg.innerHTML = '';
  for(let i=1;i<=totalPages;i++){
    const b = document.createElement('button'); b.textContent = i;
    if(i===currentCommentPage) b.style.fontWeight='700';
    b.addEventListener('click', ()=>{ currentCommentPage = i; renderComments(); });
    pg.appendChild(b);
  }
}

/* submit comment */
function onSubmitComment(){
  if(!currentPostId) return alert('ê²Œì‹œê¸€ì„ ì—° ë‹¤ìŒ ëŒ“ê¸€ì„ ì‘ì„±í•˜ì„¸ìš”.');
  const text = (document.getElementById('comment-input').value || '').trim();
  if(!text) return;
  const idx = bamboo.findIndex(p=>p.id===currentPostId);
  if(idx===-1) return alert('ê²Œì‹œê¸€ ì—†ìŒ');
  bamboo[idx].comments = bamboo[idx].comments || [];
  bamboo[idx].comments.push({ text, date: new Date().toLocaleString() });
  safeSave('bamboo', bamboo);
  document.getElementById('comment-input').value = '';
  // jump to last comment page
  currentCommentPage = Math.ceil(bamboo[idx].comments.length / COMMENTS_PER_PAGE);
  renderComments();
}

/* voting */
function vote(field){
  if(!currentPostId) return;
  const idx = bamboo.findIndex(p=>p.id===currentPostId);
  if(idx===-1) return;
  bamboo[idx][field] = (bamboo[idx][field] || 0) + 1;
  safeSave('bamboo', bamboo);
  document.getElementById('post-likes').textContent = bamboo[idx].likes || 0;
  document.getElementById('post-dislikes').textContent = bamboo[idx].dislikes || 0;
}

/* ---------- initial render ---------- */
function renderBambooList(){ renderBambooList(); } // placeholder overwritten below

// override with actual function reference (to avoid hoisting confusions)
renderBambooList = function(){
  // reuse function body defined earlier to render list
  const ul = document.getElementById('bamboo-titles'); ul.innerHTML='';
  const term = (document.getElementById('bamboo-search').value || '').trim().toLowerCase();
  const type = document.getElementById('bamboo-search-type').value;
  let filtered = bamboo.slice();
  if(term){
    filtered = filtered.filter(p=>{
      const t = (p.title||'').toLowerCase();
      const c = (p.content||'').toLowerCase();
      if(type==='title') return t.includes(term);
      if(type==='content') return c.includes(term);
      return t.includes(term) || c.includes(term);
    });
  }
  const total = filtered.length;
  const pages = Math.max(1, Math.ceil(total / POSTS_PER_PAGE));
  if(currentListPage > pages) currentListPage = 1;
  const start = (currentListPage-1)*POSTS_PER_PAGE;
  const pageItems = filtered.slice(start, start+POSTS_PER_PAGE);
  pageItems.forEach(p=>{
    const li = document.createElement('li'); li.className='title-item';
    li.textContent = p.title;
    li.addEventListener('click', ()=> openPostPage(p.id));
    ul.appendChild(li);
  });
  const pag = document.getElementById('bamboo-pagination'); pag.innerHTML='';
  for(let i=1;i<=pages;i++){
    const b = document.createElement('button'); b.textContent = i;
    if(i===currentListPage) b.style.fontWeight='700';
    b.addEventListener('click', ()=>{ currentListPage = i; renderBambooList(); });
    pag.appendChild(b);
  }
  // update total count (if you want to display)
  document.getElementById('bamboo-total')?.textContent = total;
};

/* ensure calendar & bamboo initial */
renderCalendar();
renderBus();
renderBambooList();

</script>
</body>
</html>
