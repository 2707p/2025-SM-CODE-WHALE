school-portal/
 â”œâ”€ docker-compose.yml
 â”œâ”€ backend/
 â”‚   â”œâ”€ package.json
 â”‚   â”œâ”€ .env.example
 â”‚   â”œâ”€ src/
 â”‚   â”‚   â”œâ”€ server.js
 â”‚   â”‚   â”œâ”€ db.js
 â”‚   â”‚   â”œâ”€ middleware/
 â”‚   â”‚   â”‚   â””â”€ auth.js
 â”‚   â”‚   â””â”€ routes/
 â”‚   â”‚       â”œâ”€ auth.js
 â”‚   â”‚       â”œâ”€ notices.js
 â”‚   â”‚       â”œâ”€ timetable.js
 â”‚   â”‚       â”œâ”€ events.js
 â”‚   â”‚       â””â”€ shuttle.js
 â”‚   â””â”€ scripts/
 â”‚       â”œâ”€ schema.sql
 â”‚       â””â”€ seed.js
 â””â”€ frontend/
     â”œâ”€ package.json
     â”œâ”€ next.config.js
     â”œâ”€ .env.local.example
     â”œâ”€ styles/globals.css
     â”œâ”€ lib/
     â”‚  â”œâ”€ api.js
     â”‚  â””â”€ auth.js
     â”œâ”€ components/
     â”‚  â”œâ”€ Layout.js
     â”‚  â”œâ”€ NoticeBar.js
     â”‚  â””â”€ WidgetCard.js
     â””â”€ pages/
        â”œâ”€ _app.js
        â”œâ”€ login.js
        â”œâ”€ dashboard.js
        â”œâ”€ notice/
        â”‚  â”œâ”€ index.js
        â”‚  â””â”€ [id].js
        â”œâ”€ timetable.js
        â”œâ”€ events/
        â”‚  â””â”€ index.js
        â””â”€ shuttle.js

version: "3.9"
services:
  db:
    image: postgres:15
    container_name: school_portal_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: portal
      POSTGRES_PASSWORD: portalpw
      POSTGRES_DB: portaldb
    ports:
      - "5432:5432"
    volumes:
      - dbdata:/var/lib/postgresql/data
volumes:
  dbdata:

{
  "name": "school-portal-backend",
  "version": "1.0.0",
  "main": "src/server.js",
  "type": "module",
  "scripts": {
    "dev": "node src/server.js",
    "seed": "node scripts/seed.js"
  },
  "dependencies": {
    "bcrypt": "^5.1.1",
    "cors": "^2.8.5",
    "dotenv": "^16.4.5",
    "express": "^4.19.2",
    "jsonwebtoken": "^9.0.2",
    "pg": "^8.12.0"
  }
}

PORT=4000
DATABASE_URL=postgres://portal:portalpw@localhost:5432/portaldb
JWT_SECRET=replace_with_long_random_string

import pkg from 'pg';
import dotenv from 'dotenv';
dotenv.config();

const { Pool } = pkg;
export const pool = new Pool({
  connectionString: process.env.DATABASE_URL
});

export async function query(sql, params = []) {
  const client = await pool.connect();
  try {
    const res = await client.query(sql, params);
    return res;
  } finally {
    client.release();
  }
}

import jwt from 'jsonwebtoken';
import dotenv from 'dotenv';
dotenv.config();

export function requireAuth(req, res, next) {
  const header = req.headers.authorization || '';
  const token = header.startsWith('Bearer ') ? header.slice(7) : null;
  if (!token) return res.status(401).json({ error: 'í† í° ì—†ìŒ' });

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded; // { studentId, name, iat, exp }
    next();
  } catch (e) {
    return res.status(401).json({ error: 'í† í° ìœ íš¨í•˜ì§€ ì•ŠìŒ' });
  }
}

import express from 'express';
import jwt from 'jsonwebtoken';
import bcrypt from 'bcrypt';
import { query } from '../db.js';
import dotenv from 'dotenv';
dotenv.config();

const router = express.Router();

// ë¡œê·¸ì¸
router.post('/login', async (req, res) => {
  try {
    const { studentId, password } = req.body;
    const r = await query('SELECT * FROM students WHERE student_id=$1', [studentId]);
    if (!r.rows.length) return res.status(401).json({ error: 'í•™ìƒ ì—†ìŒ' });

    const s = r.rows[0];
    const ok = await bcrypt.compare(password, s.password_hash);
    if (!ok) return res.status(401).json({ error: 'ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜' });

    const token = jwt.sign({ studentId: s.student_id, name: s.name }, process.env.JWT_SECRET, { expiresIn: '2h' });
    res.json({ token, mustChangePassword: s.must_change_password, studentId: s.student_id, name: s.name });
  } catch (e) {
    console.error(e);
    res.status(500).json({ error: 'ì„œë²„ ì˜¤ë¥˜' });
  }
});

// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
router.post('/change-password', async (req, res) => {
  try {
    const { studentId, oldPassword, newPassword } = req.body;
    const r = await query('SELECT * FROM students WHERE student_id=$1', [studentId]);
    if (!r.rows.length) return res.status(400).json({ error: 'í•™ìƒ ì—†ìŒ' });

    const s = r.rows[0];
    const ok = await bcrypt.compare(oldPassword, s.password_hash);
    if (!ok) return res.status(401).json({ error: 'ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜' });

    const newHash = await bcrypt.hash(newPassword, 10);
    await query('UPDATE students SET password_hash=$1, must_change_password=false WHERE student_id=$2', [newHash, studentId]);
    res.json({ message: 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì„±ê³µ' });
  } catch (e) {
    console.error(e);
    res.status(500).json({ error: 'ì„œë²„ ì˜¤ë¥˜' });
  }
});

export default router;

import express from 'express';
import { query } from '../db.js';
import { requireAuth } from '../middleware/auth.js';

const router = express.Router();

// ê³µì§€ ëª©ë¡ (ìµœì‹ ìˆœ)
router.get('/', requireAuth, async (req, res) => {
  try {
    const limit = Math.min(parseInt(req.query.limit || '20', 10), 100);
    const r = await query('SELECT id, title, content, created_at FROM notices ORDER BY created_at DESC LIMIT $1', [limit]);
    res.json(r.rows);
  } catch (e) {
    console.error(e);
    res.status(500).json({ error: 'ì„œë²„ ì˜¤ë¥˜' });
  }
});

// ê³µì§€ ìƒì„¸
router.get('/:id', requireAuth, async (req, res) => {
  try {
    const r = await query('SELECT id, title, content, created_at FROM notices WHERE id=$1', [req.params.id]);
    if (!r.rows.length) return res.status(404).json({ error: 'ê³µì§€ ì—†ìŒ' });
    res.json(r.rows[0]);
  } catch (e) {
    console.error(e);
    res.status(500).json({ error: 'ì„œë²„ ì˜¤ë¥˜' });
  }
});

export default router;

import express from 'express';
import { query } from '../db.js';
import { requireAuth } from '../middleware/auth.js';

const router = express.Router();

// ë‚´ ì‹œê°„í‘œ (í† í°ì˜ studentId ê¸°ì¤€)
router.get('/', requireAuth, async (req, res) => {
  try {
    const sid = req.user.studentId;
    const r = await query(
      `SELECT day, subject, room, 
              to_char(start_time, 'HH24:MI') as start_time, 
              to_char(end_time, 'HH24:MI') as end_time
       FROM timetable WHERE student_id=$1
       ORDER BY 
         CASE day 
           WHEN 'Mon' THEN 1 WHEN 'Tue' THEN 2 WHEN 'Wed' THEN 3 
           WHEN 'Thu' THEN 4 WHEN 'Fri' THEN 5 ELSE 6 END, start_time`,
      [sid]
    );
    res.json(r.rows);
  } catch (e) {
    console.error(e);
    res.status(500).json({ error: 'ì„œë²„ ì˜¤ë¥˜' });
  }
});

export default router;

import express from 'express';
import { query } from '../db.js';
import { requireAuth } from '../middleware/auth.js';

const router = express.Router();

// í•™ì‚¬ì¼ì •/í–‰ì‚¬ ëª©ë¡ (type í•„í„° ê°€ëŠ¥: í•™ì‚¬ì¼ì •, í–‰ì‚¬)
router.get('/', requireAuth, async (req, res) => {
  try {
    const { type } = req.query;
    const params = [];
    let sql = 'SELECT id, title, description, event_date, type FROM events';
    if (type) {
      sql += ' WHERE type=$1';
      params.push(type);
    }
    sql += ' ORDER BY event_date ASC';
    const r = await query(sql, params);
    res.json(r.rows);
  } catch (e) {
    console.error(e);
    res.status(500).json({ error: 'ì„œë²„ ì˜¤ë¥˜' });
  }
});

export default router;

import express from 'express';
import { query } from '../db.js';
import { requireAuth } from '../middleware/auth.js';

const router = express.Router();

// ì…”í‹€ í˜„í™© ì „ì²´(ê°„ë‹¨)
router.get('/', requireAuth, async (req, res) => {
  try {
    const r = await query(
      `SELECT id, bus_id, status, lat, lng, next_stop, 
              to_char(updated_at, 'YYYY-MM-DD HH24:MI:SS') as updated_at 
       FROM shuttles ORDER BY bus_id`
    );
    res.json(r.rows);
  } catch (e) {
    console.error(e);
    res.status(500).json({ error: 'ì„œë²„ ì˜¤ë¥˜' });
  }
});

export default router;


import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import authRoutes from './routes/auth.js';
import noticeRoutes from './routes/notices.js';
import timetableRoutes from './routes/timetable.js';
import eventRoutes from './routes/events.js';
import shuttleRoutes from './routes/shuttle.js';

dotenv.config();
const app = express();

app.use(cors({ origin: 'http://localhost:3000', credentials: true }));
app.use(express.json());

app.get('/health', (_, res) => res.json({ ok: true }));

app.use('/auth', authRoutes);
app.use('/notices', noticeRoutes);
app.use('/timetable', timetableRoutes);
app.use('/events', eventRoutes);
app.use('/shuttle', shuttleRoutes);

const PORT = process.env.PORT || 4000;
app.listen(PORT, () => console.log(`API running on http://localhost:${PORT}`));

-- students
CREATE TABLE IF NOT EXISTS students (
  id SERIAL PRIMARY KEY,
  student_id VARCHAR(20) UNIQUE NOT NULL,
  name VARCHAR(50) NOT NULL,
  password_hash TEXT NOT NULL,
  must_change_password BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
);

-- timetable
CREATE TABLE IF NOT EXISTS timetable (
  id SERIAL PRIMARY KEY,
  student_id VARCHAR(20) REFERENCES students(student_id),
  subject VARCHAR(100) NOT NULL,
  day VARCHAR(10) NOT NULL,
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  room VARCHAR(50) NOT NULL
);

-- notices
CREATE TABLE IF NOT EXISTS notices (
  id SERIAL PRIMARY KEY,
  title VARCHAR(200) NOT NULL,
  content TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

-- events
CREATE TABLE IF NOT EXISTS events (
  id SERIAL PRIMARY KEY,
  title VARCHAR(200) NOT NULL,
  description TEXT,
  event_date DATE NOT NULL,
  type VARCHAR(20) NOT NULL
);

-- shuttles
CREATE TABLE IF NOT EXISTS shuttles (
  id SERIAL PRIMARY KEY,
  bus_id VARCHAR(10) NOT NULL,
  status VARCHAR(20) NOT NULL,
  lat DECIMAL(10,7),
  lng DECIMAL(10,7),
  next_stop VARCHAR(50),
  updated_at TIMESTAMP DEFAULT NOW()
);

import dotenv from 'dotenv';
dotenv.config();
import bcrypt from 'bcrypt';
import { query } from '../src/db.js';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

async function main() {
  // ìŠ¤í‚¤ë§ˆ ìƒì„±
  const schema = fs.readFileSync(path.join(__dirname, 'schema.sql'), 'utf8');
  await query(schema);

  // í•™ìƒ 1ëª… + ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸
  const studentId = '20230001';
  const name = 'í™ê¸¸ë™';
  const initialPw = 'Passw0rd!';
  const hash = await bcrypt.hash(initialPw, 10);

  await query(
    `INSERT INTO students (student_id, name, password_hash, must_change_password)
     VALUES ($1,$2,$3,true)
     ON CONFLICT (student_id) DO UPDATE SET name=EXCLUDED.name`,
    [studentId, name, hash]
  );

  // ì‹œê°„í‘œ (ìƒ˜í”Œ)
  await query(`DELETE FROM timetable WHERE student_id=$1`, [studentId]);
  await query(
    `INSERT INTO timetable (student_id, subject, day, start_time, end_time, room) VALUES
     ($1,'ìë£Œêµ¬ì¡°','Mon','09:00','10:30','IT301'),
     ($1,'ìš´ì˜ì²´ì œ','Mon','13:00','14:30','IT202'),
     ($1,'ì•Œê³ ë¦¬ì¦˜','Wed','10:45','12:15','IT405'),
     ($1,'ë°ì´í„°ë² ì´ìŠ¤','Fri','11:00','12:30','IT110')`,
    [studentId]
  );

  // ê³µì§€
  await query(`DELETE FROM notices;`);
  await query(
    `INSERT INTO notices (title, content) VALUES
     ('[í•„ë…] 2í•™ê¸° ìˆ˜ê°•ì‹ ì²­ ì¼ì •', 'ìˆ˜ê°•ì‹ ì²­ì€ 9/1 09:00ë¶€í„°ì…ë‹ˆë‹¤.'),
     ('ì…”í‹€ë²„ìŠ¤ ë…¸ì„  ë³€ê²½ ì•ˆë‚´', 'ì •ë¬¸-ê¸°ìˆ™ì‚¬ ìˆœí™˜ ë…¸ì„ ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.'),
     ('ë„ì„œê´€ ê°œê´€ì‹œê°„ ë³€ê²½', 'ì‹œí—˜ê¸°ê°„ ì—°ì¥ ìš´ì˜í•©ë‹ˆë‹¤.')`
  );

  // í•™ì‚¬ì¼ì •/í–‰ì‚¬
  await query(`DELETE FROM events;`);
  await query(
    `INSERT INTO events (title, description, event_date, type) VALUES
     ('ê°œê°•ì¼', '2í•™ê¸° ê°œê°•', '2025-09-01', 'í•™ì‚¬ì¼ì •'),
     ('ìˆ˜ê°•ì •ì •', 'í¬í„¸ì—ì„œ ì •ì • ê°€ëŠ¥', '2025-09-03', 'í•™ì‚¬ì¼ì •'),
     ('ìˆ˜ê°•ì •ì • ë§ˆê°', 'ë§ˆê°ì¼', '2025-09-05', 'í•™ì‚¬ì¼ì •'),
     ('ë™ì•„ë¦¬ ë°•ëŒíšŒ', 'ì²´ìœ¡ê´€', '2025-09-07', 'í–‰ì‚¬')`
  );

  // ì…”í‹€
  await query(`DELETE FROM shuttles;`);
  await query(
    `INSERT INTO shuttles (bus_id, status, lat, lng, next_stop) VALUES
     ('A01','ìš´í–‰ì¤‘',37.5665,126.9780,'ì •ë¬¸'),
     ('B02','ëŒ€ê¸°ì¤‘',37.5650,126.9760,'ê¸°ìˆ™ì‚¬')`
  );

  console.log('Seed ì™„ë£Œ âœ…');
  console.log('ë¡œê·¸ì¸: í•™ë²ˆ 20230001 / ë¹„ë°€ë²ˆí˜¸ Passw0rd! (ì²« ë¡œê·¸ì¸ í›„ ë¹„ë²ˆ ë³€ê²½ ê¶Œì¥)');
}

main().then(()=>process.exit(0)).catch(e=>{ console.error(e); process.exit(1); });


{
  "name": "school-portal-frontend",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev -p 3000",
    "build": "next build",
    "start": "next start -p 3000"
  },
  "dependencies": {
    "axios": "^1.7.2",
    "next": "14.2.4",
    "react": "18.2.0",
    "react-dom": "18.2.0"
  }
}

NEXT_PUBLIC_API_BASE=http://localhost:4000

/** @type {import('next').NextConfig} */
const nextConfig = { reactStrictMode: true };
export default nextConfig;

* { box-sizing: border-box; }
body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen; background: #f6f7fb; color: #111; }
a { color: #2563eb; text-decoration: none; }
.container { max-width: 1080px; margin: 0 auto; padding: 24px; }
.card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; box-shadow: 0 1px 2px rgba(0,0,0,.03); }
.grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap:16px; }
.btn { padding:10px 14px; border-radius:8px; background:#2563eb; color:#fff; border:none; cursor:pointer; }
.btn.secondary { background:#6b7280; }
.input { width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:8px; margin-bottom:10px; }
.header { position:sticky; top:0; z-index:10; background:#111827; color:#fff; padding:12px 0; margin-bottom:16px; }
.header .inner { display:flex; align-items:center; justify-content:space-between; }
.header .brand { font-weight:700; }
.noticeBar { background:#fff7ed; border:1px solid #fed7aa; padding:16px; border-radius:12px; margin-bottom:16px; }
.badge { font-size:12px; color:#6b7280; }
.row { display:flex; gap:10px; align-items:center; }


import axios from 'axios';

const api = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:4000'
});

// ìš”ì²­ë§ˆë‹¤ í† í° ìë™ ì²¨ë¶€
api.interceptors.request.use(cfg => {
  if (typeof window !== 'undefined') {
    const token = localStorage.getItem('token');
    if (token) cfg.headers.Authorization = `Bearer ${token}`;
  }
  return cfg;
});

export default api;

import { useEffect } from 'react';
import { useRouter } from 'next/router';

export function useRequireAuth() {
  const router = useRouter();
  useEffect(() => {
    const token = localStorage.getItem('token');
    if (!token) router.replace('/login');
  }, [router]);
}

export function logout(router) {
  localStorage.removeItem('token');
  localStorage.removeItem('studentId');
  localStorage.removeItem('name');
  router.replace('/login');
}


import { logout } from '../lib/auth';
import { useRouter } from 'next/router';

export default function Layout({ children }) {
  const router = useRouter();
  const name = typeof window !== 'undefined' ? localStorage.getItem('name') : '';
  return (
    <>
      <div className="header">
        <div className="container inner">
          <div className="brand">ğŸ“ School Portal</div>
          <div className="row">
            <span className="badge">{name ? `${name}ë‹˜` : ''}</span>
            <button className="btn secondary" onClick={()=>logout(router)}>ë¡œê·¸ì•„ì›ƒ</button>
          </div>
        </div>
      </div>
      <div className="container">{children}</div>
    </>
  );
}

import Link from 'next/link';

export default function NoticeBar({ notices = [] }) {
  return (
    <div className="noticeBar">
      <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:8}}>
        <h2 style={{margin:0}}>ğŸ“¢ ê³µì§€ì‚¬í•­</h2>
        <Link href="/notice">ë”ë³´ê¸° â†’</Link>
      </div>
      <ul style={{margin:0, paddingLeft:18}}>
        {notices.slice(0,3).map(n => (
          <li key={n.id}>
            <Link href={`/notice/${n.id}`}>{n.title}</Link>
            <span className="badge" style={{marginLeft:8}}>{n.created_at ? new Date(n.created_at).toLocaleDateString() : ''}</span>
          </li>
        ))}
      </ul>
    </div>
  );
}

export default function WidgetCard({ title, children, onClick }) {
  return (
    <div className="card" style={{cursor:'pointer'}} onClick={onClick} role="button" tabIndex={0}>
      <h3 style={{marginTop:0}}>{title}</h3>
      <div>{children}</div>
    </div>
  );
}


import '../styles/globals.css';

export default function App({ Component, pageProps }) {
  return <Component {...pageProps} />;
}


    import { useState, useEffect } from 'react';
import { useRouter } from 'next/router';
import api from '../lib/api';

export default function Login() {
  const [studentId, setStudentId] = useState('');
  const [password, setPassword] = useState('');
  const router = useRouter();

  useEffect(()=> {
    const token = localStorage.getItem('token');
    if (token) router.replace('/dashboard');
  }, [router]);

  async function handleLogin(e) {
    e.preventDefault();
    try {
      const { data } = await api.post('/auth/login', { studentId, password });
      localStorage.setItem('token', data.token);
      localStorage.setItem('studentId', data.studentId);
      localStorage.setItem('name', data.name || '');
      if (data.mustChangePassword) {
        router.push(`/dashboard?changePw=1`);
      } else {
        router.push('/dashboard');
      }
    } catch (err) {
      alert('ë¡œê·¸ì¸ ì‹¤íŒ¨ âŒ');
    }
  }

  return (
    <div className="container" style={{maxWidth:420}}>
      <h1>í•™ìƒ ë¡œê·¸ì¸</h1>
      <form onSubmit={handleLogin}>
        <input className="input" placeholder="í•™ë²ˆ" value={studentId} onChange={e=>setStudentId(e.target.value)} />
        <input className="input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" value={password} onChange={e=>setPassword(e.target.value)} />
        <button className="btn" type="submit">ë¡œê·¸ì¸</button>
      </form>
      <div style={{marginTop:16, fontSize:13, color:'#6b7280'}}>
        ìƒ˜í”Œ ê³„ì •: í•™ë²ˆ <b>20230001</b> / ë¹„ë°€ë²ˆí˜¸ <b>Passw0rd!</b>
      </div>
    </div>
  );
}


    import { useState, useEffect } from 'react';
import { useRouter } from 'next/router';
import api from '../lib/api';

export default function Login() {
  const [studentId, setStudentId] = useState('');
  const [password, setPassword] = useState('');
  const router = useRouter();

  useEffect(()=> {
    const token = localStorage.getItem('token');
    if (token) router.replace('/dashboard');
  }, [router]);

  async function handleLogin(e) {
    e.preventDefault();
    try {
      const { data } = await api.post('/auth/login', { studentId, password });
      localStorage.setItem('token', data.token);
      localStorage.setItem('studentId', data.studentId);
      localStorage.setItem('name', data.name || '');
      if (data.mustChangePassword) {
        router.push(`/dashboard?changePw=1`);
      } else {
        router.push('/dashboard');
      }
    } catch (err) {
      alert('ë¡œê·¸ì¸ ì‹¤íŒ¨ âŒ');
    }
  }

  return (
    <div className="container" style={{maxWidth:420}}>
      <h1>í•™ìƒ ë¡œê·¸ì¸</h1>
      <form onSubmit={handleLogin}>
        <input className="input" placeholder="í•™ë²ˆ" value={studentId} onChange={e=>setStudentId(e.target.value)} />
        <input className="input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" value={password} onChange={e=>setPassword(e.target.value)} />
        <button className="btn" type="submit">ë¡œê·¸ì¸</button>
      </form>
      <div style={{marginTop:16, fontSize:13, color:'#6b7280'}}>
        ìƒ˜í”Œ ê³„ì •: í•™ë²ˆ <b>20230001</b> / ë¹„ë°€ë²ˆí˜¸ <b>Passw0rd!</b>
      </div>
    </div>
  );
}


    import { useEffect, useState } from 'react';
import { useRouter } from 'next/router';
import Layout from '../components/Layout';
import NoticeBar from '../components/NoticeBar';
import WidgetCard from '../components/WidgetCard';
import api from '../lib/api';
import { useRequireAuth } from '../lib/auth';

export default function Dashboard() {
  useRequireAuth();
  const router = useRouter();
  const [notices, setNotices] = useState([]);
  const [timetable, setTimetable] = useState([]);
  const [events, setEvents] = useState([]);
  const [shuttle, setShuttle] = useState([]);
  const [pwForm, setPwForm] = useState({ old:'', nw:'' });

  useEffect(() => {
    async function load() {
      try {
        const [n, t, e, s] = await Promise.all([
          api.get('/notices?limit=3'),
          api.get('/timetable'),
          api.get('/events'),
          api.get('/shuttle')
        ]);
        setNotices(n.data);
        setTimetable(t.data);
        setEvents(e.data);
        setShuttle(s.data);
      } catch (e) { /* noop */ }
    }
    load();
  }, []);

  async function changePw() {
    try {
      const studentId = localStorage.getItem('studentId');
      await api.post('/auth/change-password', { studentId, oldPassword: pwForm.old, newPassword: pwForm.nw });
      alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ âœ…');
      router.replace('/dashboard');
    } catch {
      alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨ âŒ');
    }
  }

  const needChange = router.query.changePw === '1';
  const today = new Date();
  const todayName = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][today.getDay()];
  const todayLectures = timetable.filter(t => t.day === todayName);

  const upcoming = events
    .filter(e => new Date(e.event_date) >= new Date(today.toDateString()))
    .slice(0,3);

  return (
    <Layout>
      <NoticeBar notices={notices} />

      {needChange && (
        <div className="card" style={{marginBottom:16, borderColor:'#f43f5e'}}>
          <b>ğŸ” ìµœì´ˆ ë¡œê·¸ì¸: ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”</b>
          <div className="row" style={{marginTop:10}}>
            <input className="input" type="password" placeholder="ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸" value={pwForm.old} onChange={e=>setPwForm({...pwForm, old:e.target.value})}/>
            <input className="input" type="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" value={pwForm.nw} onChange={e=>setPwForm({...pwForm, nw:e.target.value})}/>
            <button className="btn" onClick={changePw}>ë³€ê²½</button>
          </div>
        </div>
      )}

      <div className="grid">
        <WidgetCard title="ğŸ“… ì˜¤ëŠ˜ì˜ ì‹œê°„í‘œ" onClick={()=>router.push('/timetable')}>
          {todayLectures.length === 0 && <div>ì˜¤ëŠ˜ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
          {todayLectures.map((t, i)=>(
            <div key={i}>- {t.start_time} {t.subject} ({t.room})</div>
          ))}
        </WidgetCard>

        <WidgetCard title="ğŸ“† ë‹¤ê°€ì˜¬ ì¼ì •/í–‰ì‚¬" onClick={()=>router.push('/events')}>
          {upcoming.map((e)=>(
            <div key={e.id}>- {new Date(e.event_date).toLocaleDateString()} {e.title} <span className="badge">[{e.type}]</span></div>
          ))}
          {upcoming.length===0 && <div>ë‹¤ê°€ì˜¬ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
        </WidgetCard>

        <WidgetCard title="ğŸšŒ ì…”í‹€ë²„ìŠ¤ í˜„í™©" onClick={()=>router.push('/shuttle')}>
          {shuttle.map(s=>(
            <div key={s.id}>[{s.bus_id}] {s.status} â†’ {s.next_stop} <span className="badge">{s.updated_at}</span></div>
          ))}
        </WidgetCard>

        <WidgetCard title="ğŸ“¢ ê³µì§€ ë”ë³´ê¸°" onClick={()=>router.push('/notice')}>
          ìµœì‹  ê³µì§€ë¥¼ ëª¨ë‘ ë³´ë ¤ë©´ í´ë¦­í•˜ì„¸ìš”.
        </WidgetCard>
      </div>
    </Layout>
  );
}


    import { useEffect, useState } from 'react';
import Layout from '../../components/Layout';
import api from '../../lib/api';
import { useRequireAuth } from '../../lib/auth';
import Link from 'next/link';

export default function NoticeList() {
  useRequireAuth();
  const [list, setList] = useState([]);
  useEffect(()=>{ api.get('/notices').then(r=>setList(r.data)); }, []);
  return (
    <Layout>
      <div className="card">
        <h2>ê³µì§€ì‚¬í•­</h2>
        <ul>
          {list.map(n=>(
            <li key={n.id} style={{marginBottom:8}}>
              <Link href={`/notice/${n.id}`}>{n.title}</Link>
              <span className="badge" style={{marginLeft:8}}>{n.created_at ? new Date(n.created_at).toLocaleDateString() : ''}</span>
            </li>
          ))}
        </ul>
      </div>
    </Layout>
  );
}


    import { useRouter } from 'next/router';
import { useEffect, useState } from 'react';
import Layout from '../../components/Layout';
import api from '../../lib/api';
import { useRequireAuth } from '../../lib/auth';

export default function NoticeDetail() {
  useRequireAuth();
  const router = useRouter();
  const { id } = router.query;
  const [notice, setNotice] = useState(null);

  useEffect(()=>{ if(id) api.get(`/notices/${id}`).then(r=>setNotice(r.data)); }, [id]);

  return (
    <Layout>
      <div className="card">
        {!notice && 'ë¡œë”©...'}
        {notice && (
          <>
            <h2 style={{marginTop:0}}>{notice.title}</h2>
            <div className="badge">{notice.created_at ? new Date(notice.created_at).toLocaleString() : ''}</div>
            <div style={{whiteSpace:'pre-wrap', marginTop:12}}>{notice.content}</div>
          </>
        )}
      </div>
    </Layout>
  );
}


    import { useEffect, useState } from 'react';
import Layout from '../components/Layout';
import api from '../lib/api';
import { useRequireAuth } from '../lib/auth';

const days = ['Mon','Tue','Wed','Thu','Fri'];

export default function Timetable() {
  useRequireAuth();
  const [rows, setRows] = useState([]);

  useEffect(()=>{ api.get('/timetable').then(r=>setRows(r.data)); }, []);

  return (
    <Layout>
      <div className="card">
        <h2>ì£¼ê°„ ì‹œê°„í‘œ</h2>
        <table style={{width:'100%', borderCollapse:'collapse'}}>
          <thead>
            <tr>
              <th style={{textAlign:'left', borderBottom:'1px solid #e5e7eb'}}>ìš”ì¼</th>
              <th style={{textAlign:'left', borderBottom:'1px solid #e5e7eb'}}>ê³¼ëª©</th>
              <th style={{textAlign:'left', borderBottom:'1px solid #e5e7eb'}}>ì‹œê°„</th>
              <th style={{textAlign:'left', borderBottom:'1px solid #e5e7eb'}}>ê°•ì˜ì‹¤</th>
            </tr>
          </thead>
          <tbody>
            {days.map(d => rows.filter(r=>r.day===d).map((r,i)=>(
              <tr key={`${d}-${i}`}>
                <td style={{padding:'8px 0'}}>{r.day}</td>
                <td>{r.subject}</td>
                <td>{r.start_time} ~ {r.end_time}</td>
                <td>{r.room}</td>
              </tr>
            )))}
          </tbody>
        </table>
      </div>
    </Layout>
  );
}


    import { useEffect, useState } from 'react';
import Layout from '../../components/Layout';
import api from '../../lib/api';
import { useRequireAuth } from '../../lib/auth';

export default function Events() {
  useRequireAuth();
  const [type, setType] = useState('');
  const [rows, setRows] = useState([]);

  useEffect(()=>{
    const q = type ? `/events?type=${encodeURIComponent(type)}` : '/events';
    api.get(q).then(r=>setRows(r.data));
  }, [type]);

  return (
    <Layout>
      <div className="card">
        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
          <h2>í•™ì‚¬ì¼ì • / í–‰ì‚¬</h2>
          <div className="row">
            <button className={`btn secondary`} onClick={()=>setType('')}>ì „ì²´</button>
            <button className={`btn secondary`} onClick={()=>setType('í•™ì‚¬ì¼ì •')}>í•™ì‚¬ì¼ì •</button>
            <button className={`btn secondary`} onClick={()=>setType('í–‰ì‚¬')}>í–‰ì‚¬</button>
          </div>
        </div>
        <ul>
          {rows.map(e=>(
            <li key={e.id} style={{marginBottom:8}}>
              {new Date(e.event_date).toLocaleDateString()} - {e.title}
              <span className="badge" style={{marginLeft:8}}>[{e.type}]</span>
              {e.description ? <div style={{color:'#374151'}}>{e.description}</div> : null}
            </li>
          ))}
        </ul>
      </div>
    </Layout>
  );
}


    import { useEffect, useState } from 'react';
import Layout from '../components/Layout';
import api from '../lib/api';
import { useRequireAuth } from '../lib/auth';

export default function Shuttle() {
  useRequireAuth();
  const [rows, setRows] = useState([]);

  useEffect(()=>{ api.get('/shuttle').then(r=>setRows(r.data)); }, []);

  return (
    <Layout>
      <div className="card">
        <h2>ì…”í‹€ë²„ìŠ¤ í˜„í™©</h2>
        {rows.length===0 && 'ë°ì´í„° ì—†ìŒ'}
        {rows.map(s=>(
          <div key={s.id} style={{padding:'8px 0', borderBottom:'1px solid #eee'}}>
            ğŸšŒ <b>{s.bus_id}</b> â€” {s.status} â†’ ë‹¤ìŒì •ë¥˜ì¥: {s.next_stop}
            <div className="badge">ì—…ë°ì´íŠ¸: {s.updated_at}</div>
            <div className="badge">({s.lat}, {s.lng})</div>
          </div>
        ))}
      </div>
    </Layout>
  );
}


    
